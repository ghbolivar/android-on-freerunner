#summary How to run AoF completely from an SD card
= Introduction =

With AoF on SD card it is *not* necessary to flash anything to NAND of your Freerunner, not even another bootloader. The Howto here assumes you have an SD card layout where your first (primary) partition is FAT32 and your second is ext2/3. For other setups have a closer look at the patches to modify them according to your needs. Anything beyond the 2nd partition does not matter. See also [#SD_partition_layout SD partition layout]

= Details =

The setup for Cupcake and Froyo are similar but not the same, so please have a look at the section you want to build. It is also recommended to read [ImproveIt Improve it] and [BuildIt Build it] to understand general principles.

== Cupcake ==

Do the following steps in a directory where you want to build Cupcake. All prerequisites should be set up. Note the product name is fr not freerunner here!

 * get a copy of Cupcake repo
   {{{
   $ repo init -u git://gitorious.org/android-on-freerunner/freerunner_platform_manifest.git -b cupcake
   $ repo sync
   }}}
 * get the patches from here FIXME
 * patch kernel sources to not use an initrd
   {{{
   $ cd kernel
   $ cat ../kernel.patch | patch -p1
   }}}
 * patch init.rc to modify mounts
   {{{
   $ cd vendor/neo/freerunner/
   $ cat ../../../initrc.patch | patch -p1
   }}}
 * build Cupcake, e.g.
   {{{
   make TARGET_PRODUCT=freerunner
   }}}
 * after successfull build copy the necessary directories and files onto the 2nd partition (ext2/3) of your SD card using the [#Copy_to_/_Update_your_SD_installation copy script].

== Froyo ==

Do the following steps in a directory where you want to build Cupcake. All prerequisites should be set up.

 * get a copy of Froyo repo
   {{{
   $ repo init -u git://gitorious.org/android-on-freerunner/freerunner_platform_manifest.git -b froyo
   $ repo sync
   }}}
 * get the patches from here FIXME
 * patch kernel sources to not use an initrd
   {{{
   $ cd kernel
   $ cat ../kernel.patch | patch -p1
   }}}
 * patches for vendor/neo/fr directory
   {{{
   $ cd vendor/neo/fr
   $ cat ../../../vendor_neo_fr.patch | patch -p1
   }}}
   This will patch several files and also create new ones.
 * build Froyo, e.g.
   {{{
   make TARGET_PRODUCT=fr
   }}}
 * after successfull build copy the necessary directories and files onto the 2nd partition (ext2/3) of your SD card using the [#Copy_to_/_Update_your_SD_installation copy script].
 * Boot Froyo once and the replug SD card into your PC again to [#Modify_Froyo_settings modify settings], otherwise the system is way to slow to be usable.

=== Scripts ===

== Copy to / Update your SD installation ==

Make sure you have enough permissions to do the following and you have `rsync` installed.

{{{
#!/bin/bash

#replace by the directory where your build is
FROM="/mnt/android-dev/aof/out/target/product/freerunner"
#replace by mountpoint of SD card
TO="/media/android"
RSYNCOPTS=" -aP "

rsync $RSYNCOPTS $FROM/root/ $TO/
rsync $RSYNCOPTS $FROM/system/ $TO/system/
test -d "$TO/boot" || mkdir $TO/boot
rsync $RSYNCOPTS $FROM/kernel.img  $TO/boot/uImage-GTA02.bin
cp -v $TO/init $TO/sbin/init
chmod --changes -R 777 $TO
}}}

== Modify Froyo settings ==

Make sure you have enough permissions to do the following and you have `sqlite3` installed.

 * mount android SD card and navigate to settings directory
   {{{
   $ pmount android
   $ cd /media/android/data/data/com.android.providers.settings/databases/
   }}}
 * modify database
   {{{
   $ echo "REPLACE INTO \"system\" VALUES(26,'window_animation_scale','0.0'); \
     REPLACE INTO \"system\" VALUES(27,'transition_animation_scale','0.0');" | sqlite3 settings.db
   }}}

== SD partition layout ==

Use your favourite partitioning tool to create/modify the partitions on your SD card to have one FAT32 partition at the beginning, followed by one ext2/3 partition for the AoF system. Example layout:

|| partition number || mmcblk0p1    || mmcblk0p2 || mmcblk0p3 || mmcblk0p5 ||
|| filesystem       || vfat         || ext3      || ext3      || ext3      ||
|| used for         || AoF storage  || AoF system|| system X  || storage X ||

Note that for best SD usage mmcblk0p1 should be used for a third system and "AoF storage" placed in a logical partition, but I have not tested that yet. Volunteers welcome :)
See [http://wiki.openmoko.org/wiki/Qi#Boot_Order Qi boot order] why.


----
_Send your comments to [mailto:android-on-freerunner@googlegroups.com the mailing list]_